<div>


  <MolyWeb.DaisyUi.header title="Posts" items={[{"Moly", ~p"/admin"},{"posts",nil}]} />

  <div
    id="post-top-nav"
    class={["flex items-center justify-between bg-white py-2 sm:py-0  mt-12 border-b border-gray-200"]}
  >
    <.tabs_with_badges
      id={Moly.Helper.generate_random_id()}
      tabs={[
        %{
          label: "All",
          value: "",
          href: ~p"/admin/posts?#{%{@params | page: 1, post_status: nil}}",
          badge: @status_count.all
        },
        %{
          label: "Published",
          value: "publish",
          href: ~p"/admin/posts?#{%{@params | page: 1, post_status: "publish"}}",
          badge: @status_count.publish
        },
        %{
          label: "Draft",
          value: "draft",
          href: ~p"/admin/posts?#{%{@params | page: 1, post_status: "draft"}}",
          badge: @status_count.draft
        },
        %{
          label: "Scheduled",
          value: "future",
          href: ~p"/admin/posts?#{%{@params | page: 1, post_status: "future"}}",
          badge: @status_count.future
        },
        %{
          label: "Trash",
          value: "trash",
          href: ~p"/admin/posts?#{%{@params | page: 1, post_status: "trash"}}",
          badge: @status_count.trash
        }
      ]}
      current_tab={@params.post_status}
      inner_class="border-none"
    />
    <.form
      for={nil}
      class="hidden sm:block"
      phx-save="search"
      phx-key="enter"
      phx-keydown="search"
    >
      <.search_input
        id="image-search-text-input"
        name="q"
        value={@params.q}
        phx-debounce="300"
        aria-label="Search"
        phx-update="ignore"
      />
    </.form>
  </div>

  


  <div :if={@posts.results != []} class="mt-4 rounded-box border border-base-content/5 bg-base-100">
    <MolyWeb.DaisyUi.table rows={@posts.results}>
      <:col :let={row} label="Title">
        <.link href={~p"/post/#{row.post_name}"} target="_blank" class="inline"><Lucideicons.square_arrow_out_up_right class="size-4 text-gray-500 inline" /></.link> 
        <.link patch={~p"/admin/post/#{row.id}/edit"} class="hover:underline font-semibold" >
          {row.post_title}
        </.link>
      </:col>
      <:col :let={row} label="Status">
        <MolyWeb.DaisyUi.badge   color={%{draft: "accent", publish: "success", scheduled: "info", trash: "error"} |> Map.get(row.post_status)}>
          {String.capitalize("#{row.post_status}")}
        </MolyWeb.DaisyUi.badge>
      </:col>
      <:col :let={row} label="Tags">
        <span
          :for={tag <- Moly.Utilities.Post.term_taxonomy_filter(row, "post_tag")}
          id={"tag-cell-#{tag.id}"}
          class="text-sm text-base-content/80"
        >
          {tag.term.name}
        </span>
      </:col>
      <:col :let={row} label="Category">
        <span
          :for={tag <- Moly.Utilities.Post.term_taxonomy_filter(row, "category")}
          id={"tag-cell-#{tag.id}"}
          class="text-sm text-base-content/80"
        >
          {tag.term.name}
        </span>
      </:col>
      <:col :let={row} label="Created at" >
        <span class="text-sm text-base-content/80">{row.inserted_at |> Timex.format!("{Mfull} {D}, {YYYY} {h24}:{m}")}</span>
      </:col>
      <:col :let={row} label="" align="right">
        <div class="flex gap-1">
          <MolyWeb.DaisyUi.tooltip tip="Edit">
            <.link  patch={~p"/admin/post/#{row.id}/edit"}>
              <Lucideicons.pen class="size-4" />
            </.link>
          </MolyWeb.DaisyUi.tooltip>
          <MolyWeb.DaisyUi.tooltip tip="Reindex">
            <.link 
               phx-click={JS.toggle_class("animate-spin", to: "#rebuild-index-icon-#{row.id}") |> JS.push("rebuild-index")} phx-value-id={row.id} phx-value-spin-id={"#rebuild-index-icon-#{row.id}"}>
              <Lucideicons.loader_circle id={"rebuild-index-icon-#{row.id}"} class="size-4" data-loaded={JS.toggle_class("animate-spin")} />
            </.link>
          </MolyWeb.DaisyUi.tooltip>
          <MolyWeb.DaisyUi.tooltip tip="Draft" :if={row.post_status in [:publish, :trash]}>
            <.link
              phx-click="draft"
              phx-value-id={row.id}
            >
              <Lucideicons.book_dashed class="size-4" />
            </.link>
          </MolyWeb.DaisyUi.tooltip>
          <MolyWeb.DaisyUi.tooltip tip="Publish" :if={row.post_status in [:draft]}>
            <.link
              phx-click="publish"
              phx-value-id={row.id}
            >
              <Lucideicons.book class="size-4" />
            </.link>
          </MolyWeb.DaisyUi.tooltip>


          <MolyWeb.DaisyUi.tooltip tip="Delete" :if={row.post_status !== :trash}>
            <.link
              phx-click="delete"
              data-confirm="Are you sure to delete this post forever?"
              phx-value-id={row.id}
            >
              <Lucideicons.trash class="size-4" />
            </.link>
          </MolyWeb.DaisyUi.tooltip>

          <MolyWeb.DaisyUi.tooltip tip="Forever" :if={row.post_status == :trash}>
            <.link
              class="text-error"
              phx-click="delete-forever"
              data-confirm="Are you sure to delete this post forever?"
              phx-value-id={row.id}
            >
              <Lucideicons.trash_2 class="size-4" />
            </.link>
          </MolyWeb.DaisyUi.tooltip>
        </div>
      </:col>
    </MolyWeb.DaisyUi.table>
  </div>
  <.pagination
    :if={@page_meta.total_pages > 1}
    current_url={live_url(@params)}
    page_meta={@page_meta}
    class="border-none"
  />
  <div :if={@posts.results == []} class="mt-24 max-w-sm mx-auto">
    <.no_results />
  </div>
</div>


 


 